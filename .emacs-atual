;;; === CONFIGURA√á√ïES CR√çTICAS DE PERFORMANCE ===
;; Otimiza√ß√µes RADICAIS que devem vir ANTES de tudo
(setq gc-cons-threshold 200000000)  ; 200MB durante carregamento
(setq read-process-output-max (* 8 1024 1024))  ; 8MB para I/O
(setq inhibit-startup-screen t)
(setq inhibit-startup-message t)
(setq inhibit-startup-echo-area-message t)
(setq initial-major-mode 'fundamental-mode)
(setq initial-scratch-message nil)
(setq message-log-max 1000)  ; Limitar logs

;; Performance de UI radical
(setq idle-update-delay 1.0)
(setq redisplay-skip-fontification-on-input t)
(setq auto-window-vscroll nil)
(setq fast-but-imprecise-scrolling t)
(setq jit-lock-stealth-time 5)
(setq jit-lock-defer-time 0.5)

;; Interface m√≠nima ULTRA radical
(tool-bar-mode -1)
(menu-bar-mode -1) 
(scroll-bar-mode -1)
(setq visible-bell nil)
(setq ring-bell-function 'ignore)
(setq use-dialog-box nil)
(setq use-file-dialog nil)

;;; === SISTEMA DE PACOTES (Turbo) ===
(require 'package)
(let ((timeout 10))
  (add-to-list 'package-archives '("melpa" . "https://melpa.org/packages/") t)
  (package-initialize)

  ;; Bootstrap use-package ULTRA r√°pido
  (unless (package-installed-p 'use-package)
    (with-timeout (timeout (message "Timeout package refresh"))
      (package-refresh-contents)))
  
  (unless (package-installed-p 'use-package)
    (package-install 'use-package)))

(require 'use-package)
(setq use-package-always-ensure t)
(setq use-package-expand-minimally t)  ; üëà CR√çTICO para performance
(setq use-package-enable-imenu-support nil)

;;; === CONFIGURA√á√ïES PESSOAIS (M√≠nimas) ===
(defun display-warning (&rest _args) nil)
(setq warning-minimum-level :emergency)
(global-set-key [C-tab] 'other-window)
(global-set-key (kbd "C-c c") 'compile)  ; Atalho personalizado

;; Configura√ß√µes de tab
(setq tab-width 4)
(setq-default indent-tabs-mode nil)

;; Transpar√™ncia
;;(add-to-list 'default-frame-alist '(alpha . (92 . 87)))


;; LSP Mode
;;(use-package lsp-mode
;;  :init
  ;; Opcional: definir prefix key
;;  (setq lsp-keymap-prefix "C-c l")
  
;;  :hook
  ;; Ativar LSP automaticamente para linguagens espec√≠ficas
;;  ((python-mode . lsp-deferred)
;;   (js-mode . lsp-deferred)
;;   (js-jsx-mode . lsp-deferred)
;;   (typescript-mode . lsp-deferred)
;;   (elixir-mode . lsp-deferred)
;;   (web-mode . lsp-deferred)
;;   (c-mode . lsp-deferred)
;;   (c++-mode . lsp-deferred)
;;   (java-mode . lsp-deferred)
;;   (go-mode . lsp-deferred)
;;   (rust-mode . lsp-deferred))
  
;;  :commands (lsp lsp-deferred)
  
;;  :config
  ;; Configura√ß√µes importantes
;;  (setq lsp-restart 'auto-restart)
;;  (setq lsp-enable-symbol-highlighting nil)
;;  (setq lsp-enable-on-type-formatting nil)
;;  (setq lsp-auto-guess-root t)
;;  (setq lsp-signature-auto-activate nil)
;;  (setq lsp-signature-render-documentation nil)
;;  (setq lsp-ui-sideline-show-code-actions nil
;;        lsp-signature-auto-activate nil
;;        lsp-signature-render-documentation nil)
;;  (setq lsp-diagnostics-provider :none)
;;  (setq lsp-ui-doc-enable nil)
;;)

;; LSP UI - Interface visual melhorada
;;(use-package lsp-ui
;;  :after lsp-mode
;;:hook (lsp-mode . lsp-ui-mode)
;;  :config
;;  ;; Desativa o doc panel que aparece em baixo
;;  (setq lsp-ui-doc-enable nil)
;;  (setq lsp-ui-sideline-enable nil)
;;  (setq lsp-ui-sideline-enable nil) 
;;  (setq lsp-ui-peek-enable nil) 
;;  (setq lsp-ui-sideline-show-code-actions nil)
;;)

;; Company Mode - Autocompletion
;;(use-package company
;;  :ensure t
;;  :hook (after-init . global-company-mode)
;;  :config
;;  (setq company-idle-delay 0.1
;;        company-minimum-prefix-length 1
;;        company-selection-wrap-around t
;;        company-show-numbers t
;;        company-tooltip-limit 5
;;        company-tooltip-align-annotations nil
;;        company-tooltip-flip-when-above t
;;        company-tooltip-annotation nil
;;        company-format-margin-function nil)
;;)

;; Desativa Elementos
;;(setq eldoc-mode nil)
;(global-eldoc-mode -1)
;;(tab-bar-mode -1)
;;(setq lsp-headerline-breadcrumb-enable nil)
;;(setq lsp-auto-execute-action nil)
;;(setq lsp-enable-code-action nil)
;;(setq lsp-code-action-enable nil)
;;(setq company-frontends '(company-pseudo-tooltip-frontend))
;;(remove-hook 'emacs-lisp-mode-hook 'eldoc-mode)
;;(remove-hook 'lsp-mode-hook 'eldoc-mode)
;;(setq lsp-ui-sideline-show-code-actions nil)
;;(setq eldoc-mode-line-string nil) 
;;(setq company-mode-line-string nil)


(setq mode-line-misc-info nil)

(setq-default mode-line-format
  '("%e"

    ;; 1. Codifica√ß√£o do buffer
    (:eval (let ((coding (coding-system-plist buffer-file-coding-system)))
             (when (plist-get coding :name)
               (propertize (format " %s " (upcase (symbol-name (plist-get coding :name))))
                           'face '(:foreground "#d73a49" :weight bold)))))

    " "

    ;; 2. Nome do buffer - CORRE√á√ÉO AQUI
    mode-line-buffer-identification

    " "

    ;; 3. Controle de vers√£o (Git)
    (:eval (when (and vc-mode (not (string= vc-mode "")))
             (propertize (format " %s " vc-mode)
                         'face '(:foreground "#986801" :weight bold))))

    " "

    ;; 4. Modo principal
    (:eval (propertize (format " %s " (capitalize (symbol-name major-mode)))
                       'face '(:foreground "#4078f2" :weight bold)))

    " "))

;; Atualiza a mode-line
(force-mode-line-update t)

;; Opcional: fundo sutil para a mode-line (melhora contraste)
(set-face-attribute 'mode-line nil
                    :background "#f0f0f0"
                    :foreground "#333333"
                    :box '(:line-width 1 :color "#cccccc")
                    :overline nil
                    :underline nil)

(set-face-attribute 'mode-line-inactive nil
                    :background "#f8f8f8"
                    :foreground "#888888"
                    :box '(:line-width 1 :color "#dddddd"))

;;; === MAGIT CONFIGURA√á√ÉO (Carregamento Tardio) ===

;;; === MAGIT CONFIGURA√á√ÉO (PERFORMANCE RADICAL) ===

(use-package magit
  :ensure t
  :defer 10  ; Carregamento MUITO tardio - 10 segundos
  :commands (magit-status magit-dispatch magit-file-dispatch)
  :bind (("C-x g" . magit-status)
         ("C-x M-g" . magit-dispatch-popup)
         ("C-c M-g" . magit-file-dispatch))
  :init
  ;; Pr√©-configura√ß√µes LEVES que n√£o carregam o pacote
  (setq magit-define-global-key-bindings nil)  ; CR√çTICO: n√£o criar keybindings automaticamente
  
  :config
  ;; === CONFIGURA√á√ïES DE PERFORMANCE RADICAIS ===
  (setq magit-auto-revert-mode nil)
  (setq magit-commit-show-diff nil)           ; N√£o mostrar diff no commit
  (setq magit-diff-refine-hunk 'none)         ; Desativar refine de hunks
  (setq magit-section-initial-visibility-alist 
        '((stashes . hide)
          (untracked . hide)
          (unpushed . hide)
          (unpulled . hide)))
  
  ;; Refresh e atualiza√ß√µes M√çNIMAS
  (setq magit-refresh-status-buffer nil)
  (setq magit-refresh-verbose t)
  (setq magit-diff-highlight-trailing nil)
  (setq magit-diff-highlight-indentation nil)
  
  ;; Limites AGGRESSIVOS para reposit√≥rios grandes
  (setq magit-revision-insert-related-refs-limit 5)
  (setq magit-log-arguments '("--graph" "--color" "--decorate" "-n64"))
  (setq magit-diff-arguments '("--histogram" "--no-ext-diff"))
  
  ;; Desativar funcionalidades pesadas
  (setq magit-slow-hunk-threshold 1000)       ; S√≥ destacar hunks pequenos
  (setq magit-display-buffer-function 'magit-display-buffer-traditional)
  
  ;; Performance de UI
  (setq magit-diff-paint-whitespace nil)
  (setq magit-diff-highlight-hunk-body nil)
  
  ;; Cache agressivo
  (setq magit-revision-cache-limit 50)
  (setq magit-process-popup-time 10))

;;; === GIT-GUTTER ULTRA LEVE ===
(use-package git-gutter
  :ensure t
  :defer 15  ; MUITO tardio - 15 segundos
  :commands (global-git-gutter-mode git-gutter-mode)
  :hook ((prog-mode text-mode) . git-gutter-mode)
  :init
  ;; N√£o ativar automaticamente - s√≥ por hook
  (setq git-gutter:disabled-modes '(fundamental-mode org-mode image-mode pdf-view-mode))
  
  :config
  ;; Configura√ß√µes de performance RADICAIS
  (setq git-gutter:update-interval 5)         ; Atualizar a cada 5s (era 2)
  (setq git-gutter:update-hooks-interval 10)  ; Hook mais espa√ßado
  (setq git-gutter:diff-option "-U0")         ; Diff m√≠nimo
  (setq git-gutter:hide-gutter t)             ; Esconder gutter quando vazio
  (setq git-gutter:verbosity 0)               ; Sem mensagens
  
  ;; S√≠mbolos m√≠nimos
  (setq git-gutter:modified-sign "‚îÇ")
  (setq git-gutter:added-sign "‚îÇ")  
  (setq git-gutter:deleted-sign "‚§µ")
  
  ;; Desativar funcionalidades pesadas
  (setq git-gutter:ask-p nil)
  (setq git-gutter:visual-line nil)
  
  ;; Ativar apenas modo global quando configurado
  (global-git-gutter-mode +1))

;;; === PACOTES COM CARREGAMENTO ULTRA TARDIO ===

;; Evil mode - apenas o essencial
(use-package evil
  :ensure t
  :demand t
  :config
  (evil-mode 1)
  ;; M√çNIMO de configura√ß√µes
  (setq evil-want-fine-undo t)
  (setq evil-search-module 'evil-search))

;; Vertico - config m√≠nimo
(use-package vertico
  :ensure t
  :init (vertico-mode)
  :config
  (setq vertico-cycle t)
  (setq vertico-count 8))  ; Ainda menos resultados

;; Consult - carregamento MUITO tardio
(use-package consult
  :ensure t
  :defer 3  ; 3 segundos ap√≥s inatividade
  :bind (("C-s" . consult-line)
         ("C-c h" . consult-history)
         ("C-x 8" . consult-imenu)
         ("C-c f" . consult-find)
         ("C-c r" . consult-ripgrep)))

;; Orderless - m√≠nimo
(use-package orderless
  :ensure t
  :defer 2
  :custom (completion-styles '(orderless basic)))  ; basic como fallback

;; Marginalia - MUITO tardio
(use-package marginalia
  :ensure t
  :after vertico
  :defer 5  ; 5 segundos!
  :init (marginalia-mode))

;; Tema - usar tema EMBUTIDO (remove gruber-darker)
;; REMOVER completamente: (use-package gruber-darker-theme ...)
(use-package gruber-darker-theme)
(load-theme 'gruber-darker t)

;;; === MODOS DE LINGUAGEM (Sob demanda REAL) ===

;; TypeScript - apenas quando ABRIR arquivo
(use-package typescript-mode
  :ensure t
  :defer t
  :mode ("\\.tsx?\\'" . typescript-mode)
  :init (setq typescript-indent-level 2))

;; Go - apenas quando ABRIR arquivo  
(use-package go-ts-mode
  :ensure t
  :defer t
  :mode ("\\.go\\'" . go-ts-mode))

;; Elixir - apenas quando ABRIR arquivo
(use-package elixir-mode
  :ensure t
  :defer t
  :hook (elixir-mode . (lambda () (subword-mode 1)))
  :config (setq elixir-basic-offset 2))

;;; === CONFIGURA√á√ïES DE APAR√äNCIA (ADIADAS) ===

;; Fontes - ADIAR significativamente
(run-with-idle-timer 3 nil
  (lambda ()
    (add-to-list 'default-frame-alist '(font . "Iosevka-14"))))  ; Tamanho menor = mais r√°pido

;;; === NUMERA√á√ÉO DE LINHAS INTELIGENTE ===
;; Ativar apenas em modos de programa√ß√£o e texto
(add-hook 'prog-mode-hook 'display-line-numbers-mode)
(add-hook 'text-mode-hook 'display-line-numbers-mode)

;; Desativar em modos onde n√£o √© √∫til
(add-hook 'dired-mode-hook (lambda () (display-line-numbers-mode -1)))
(add-hook 'vterm-mode-hook (lambda () (display-line-numbers-mode -1)))
(add-hook 'shell-mode-hook (lambda () (display-line-numbers-mode -1)))
(add-hook 'eshell-mode-hook (lambda () (display-line-numbers-mode -1)))
(add-hook 'compilation-mode-hook (lambda () (display-line-numbers-mode -1)))
(add-hook 'help-mode-hook (lambda () (display-line-numbers-mode -1)))
(add-hook 'info-mode-hook (lambda () (display-line-numbers-mode -1)))

;; Vers√£o NUCLEAR - Desativar TODAS as confirma√ß√µes do sistema
(defun my-always-yes (&rest args) t)
(advice-add 'yes-or-no-p :override 'my-always-yes)
(advice-add 'y-or-n-p :override 'my-always-yes)

;; Maximizar - ADIAR
(run-with-idle-timer 1 nil 'toggle-frame-maximized)

;; Tema EMBUTIDO - carregar r√°pido
;;(load-theme 'tango-dark t)
;;(load-theme 'wombat t)
;;(load-theme 'manoj-dark t)
;;(load-theme 'wheatgrass t)
;;(set-face-background 'default "#181818")
;;(set-face-foreground 'default "#e4e4e4")

;;; === CONFIGURA√á√ïES DE PERFORMANCE RADICAIS ===

;; GC inteligente AGGRESSIVO
(defun my-minibuffer-setup-hook ()
  (setq gc-cons-threshold 400000000))  ; 400MB durante minibuffer!

(defun my-minibuffer-exit-hook ()
  (setq gc-cons-threshold 200000000))  ; 200MB ap√≥s minibuffer

(add-hook 'minibuffer-setup-hook #'my-minibuffer-setup-hook)
(add-hook 'minibuffer-exit-hook #'my-minibuffer-exit-hook)

;; Sistema de arquivos ULTRA r√°pido
(setq auto-save-default nil)  ; üö® DESATIVAR auto-save durante startup
(setq create-lockfiles nil)
(setq backup-directory-alist `(("." . "~/.emacs.d/backups")))
(setq auto-save-list-file-prefix nil)  ; N√£o criar auto-save-list

;; Busca r√°pida
(setq case-fold-search t)
(setq search-upper-case 'not-symbols)

;;; === CONFIGURA√á√ïES ADICIONAIS (ADIADAS RADICALMENTE) ===

;; Midnight - ADIAR muito
(run-with-idle-timer 15 nil 
  (lambda ()
    (require 'midnight)
    (midnight-mode 1)))

;; Tree-sitter - apenas se necess√°rio
(run-with-idle-timer 10 nil
  (lambda ()
    (when (fboundp 'treesit-available-p)
      (setq treesit-font-lock-level 1))))  ; N√≠vel M√çNIMO

;; Eglot - CARREGAMENTO POR DEMANDA REAL
(use-package eglot
  :ensure t
  :defer t
  :commands (eglot eglot-ensure)
  :init
  (setq eglot-events-buffer-size 0
        eglot-sync-connect 0
        eglot-connect-timeout 30))

;;; === CONFIGURA√á√ïES DE MODOS (M√çNIMAS) ===

;; Electric pair - leve
(electric-pair-mode 1)

;; C mode - configura√ß√£o m√≠nima
(setq-default c-basic-offset 4)
(add-hook 'c-mode-hook (lambda () (c-toggle-comment-style -1)))

;; Emacs Lisp - apenas o essencial
(add-hook 'emacs-lisp-mode-hook
          (lambda ()
            (local-set-key (kbd "C-c C-j") 'eval-print-last-sexp)))

;; Word wrap - apenas quando necess√°rio
(add-hook 'markdown-mode-hook (lambda () (toggle-word-wrap 1)))

;; Modos de arquivo - direto
(dolist (pair '(("Cask" . emacs-lisp-mode)
                ("\\.html\\'" . nxml-mode)
                ("\\.xsd\\'" . nxml-mode)
                ("\\.ant\\'" . nxml-mode)
                ("\\.ebi\\'" . lisp-mode)))
  (add-to-list 'auto-mode-alist pair))

;;; === CONFIRMA√á√ïES AUTOM√ÅTICAS ===
(setq confirm-nonexistent-file-or-buffer nil)
(setq confirm-kill-processes nil)
(setq confirm-kill-emacs nil)

;; TRAMP config m√≠nima
(setq tramp-auto-save-directory "/tmp")

;;; === CONFIGURA√á√ïES FINAIS DE PERFORMANCE ===

;; Reset FINAL do GC
(add-hook 'emacs-startup-hook
  (lambda ()
    (setq gc-cons-threshold 100000000) 
    ;; Re-ativar auto-save AP√ìS startup
    (setq auto-save-default t)
    (message "Loaded in %.2f s!" 
             (float-time (time-subtract after-init-time before-init-time)))))

;;; === CONFIGURA√á√ÉO DO ARQUIVO CUSTOM ===
;; TUDO que for configurado via customize vai para este arquivo
(setq custom-file "~/.emacs.d/custom.el")

;; Carregar o arquivo custom se existir
(when (file-exists-p custom-file)
  (load custom-file))

;; Fun√ß√£o para garantir que customiza√ß√µes sejam salvas no lugar certo
(defun my-save-custom-file ()
  "Salvar customiza√ß√µes no arquivo correto."
  (unless (file-exists-p custom-file)
    (write-region "" nil custom-file))
  (custom-save-all))

;; Salvar automaticamente quando usar customize
(setq custom-save-dir "~/.emacs.d/")
(add-hook 'after-init-hook 'my-save-custom-file)

;; Mensagem final MINIMAL
(message "Iniciando...")
