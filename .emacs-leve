;;; === CONFIGURAÇÕES CRÍTICAS DE PERFORMANCE ===
;; Otimizações que devem vir ANTES de tudo
(setq gc-cons-threshold 100000000)  ; 100MB durante carregamento
(setq read-process-output-max (* 4 1024 1024))  ; 4MB para I/O
(setq inhibit-startup-screen t)
(setq inhibit-startup-message t)
(setq inhibit-startup-echo-area-message t)
(setq initial-major-mode 'fundamental-mode)
(setq initial-scratch-message nil)

;; Interface mínima desde o início
(tool-bar-mode -1)
(menu-bar-mode -1) 
(scroll-bar-mode -1)
(setq visible-bell nil)
(setq ring-bell-function 'ignore)

;;; === SISTEMA DE PACOTES (Otimizado) ===
(require 'package)
(add-to-list 'package-archives '("melpa" . "https://melpa.org/packages/") t)
(package-initialize)

;; Bootstrap use-package rápido
(unless (package-installed-p 'use-package)
  (package-refresh-contents)
  (package-install 'use-package))

(require 'use-package)
(setq use-package-always-ensure t)

;;; === CONFIGURAÇÕES PESSOAIS (Leves) ===
(defun display-warning (&rest _args) nil)
(setq warning-minimum-level :emergency)
(global-set-key [C-tab] 'other-window)

;; Configurações de tab
(setq tab-width 4)
(setq-default indent-tabs-mode nil)

;; Transparência
(add-to-list 'default-frame-alist '(alpha . (92 . 87)))

;;; === PACOTES COM CARREGAMENTO TARDIO INTELIGENTE ===

;; Evil mode - carregar primeiro mas de forma otimizada
(use-package evil
  :ensure t
  :demand t  ; Precisamos dele logo
  :config
  (evil-mode 1)
  ;; Otimizações específicas do evil
  (setq evil-want-fine-undo t)
  (setq evil-search-module 'evil-search)
  (setq evil-ex-complete-emacs-commands nil))

;; Vertico - completion rápido
(use-package vertico
  :ensure t
  :init
  (vertico-mode)
  :config
  (setq vertico-cycle t)
  (setq vertico-count 10)  ; Menos resultados = mais rápido
  (setq vertico-resize nil))

;; Consult - buscar sob demanda
(use-package consult
  :ensure t
  :defer 1  ; Carregar após 1 segundo de inatividade
  :bind (("C-s" . consult-line)
         ("C-c h" . consult-history)
         ("C-x 8" . consult-imenu)
         ("C-c f" . consult-find)
         ("C-c r" . consult-ripgrep))
  :init (consult-preview-at-point-mode))

;; Orderless - deferido
(use-package orderless
  :ensure t
  :defer 1
  :custom (completion-styles '(orderless)))

;; Marginalia - carregar após vertico
(use-package marginalia
  :ensure t
  :after vertico
  :defer 1
  :init (marginalia-mode))

;; Tema - carregar por último
(use-package gruber-darker-theme
  :ensure t
  :defer 2  ; Carregar após 2 segundos
  :config
  (load-theme 'gruber-darker t))

;;; === MODOS DE LINGUAGEM (Carregamento por extensão) ===

;; TypeScript - só quando necessário
(use-package typescript-mode
  :ensure t
  :defer t
  :mode ("\\.ts\\'" . typescript-mode))

;; Go - com tree-sitter se disponível
(use-package go-ts-mode
  :ensure t
  :defer t
  :mode ("\\.go\\'" . go-ts-mode))

;; Elixir - modo leve
(use-package elixir-mode
  :ensure t
  :defer t
  :hook (elixir-mode . (lambda ()
                        (subword-mode 1)
                        (eldoc-mode 1)))
  :config (setq elixir-basic-offset 2))

;;; === CONFIGURAÇÕES DE APARÊNCIA (AtrasadAS) ===

;; Fontes - configurar após o tema
(run-with-idle-timer 1 nil
  (lambda ()
    (defun rc/get-default-font ()
      (cond
       ((eq system-type 'gnu/linux) "Iosevka-20")))
    (add-to-list 'default-frame-alist `(font . ,(rc/get-default-font)))))

;; Line numbers - apenas quando necessário
(add-hook 'prog-mode-hook 'display-line-numbers-mode)
;; Remova ou comente esta linha: (global-display-line-numbers-mode 1)

;; Maximizar após startup
(add-hook 'emacs-startup-hook #'toggle-frame-maximized)

;; Tema
(load-theme 'tango-dark t)

;;; === CONFIGURAÇÕES DE PERFORMANCE AVANÇADAS ===

;; GC inteligente para minibuffer
(defun my-minibuffer-setup-hook ()
  (setq gc-cons-threshold most-positive-fixnum))

(defun my-minibuffer-exit-hook ()
  (setq gc-cons-threshold 800000))  ; 800KB padrão

(add-hook 'minibuffer-setup-hook #'my-minibuffer-setup-hook)
(add-hook 'minibuffer-exit-hook #'my-minibuffer-exit-hook)

;; Otimizações de rendering
(setq redisplay-skip-fontification-on-input t)
(setq auto-window-vscroll nil)
(setq fast-but-imprecise-scrolling t)
(setq jit-lock-stealth-time 3)
(setq jit-lock-defer-time 0)

;; Sistema de arquivos
(setq auto-save-default t)
(setq create-lockfiles nil)
(setq backup-directory-alist `(("." . "~/.emacs.d/backups")))

;; Busca
(setq case-fold-search t)
(setq search-upper-case 'not-symbols)

;;; === CONFIGURAÇÕES ADICIONAIS (Deferidas) ===

;; Midnight - limpeza automática
(use-package midnight
  :defer 10  ; Carregar após 10 segundos
  :config
  (midnight-mode 1))

;; Tree-sitter - se disponível
(when (fboundp 'treesit-available-p)
  (use-package treesit
    :defer t
    :config
    (setq treesit-font-lock-level 2)))  ; Nível menor = mais rápido

;; Eglot - apenas quando invocado
(use-package eglot
  :ensure t
  :defer t
  :commands eglot
  :config
  (setq eglot-events-buffer-size 0)
  (setq eglot-sync-connect 1)
  (setq eglot-connect-timeout 10))

;;; === CONFIGURAÇÕES DE MODOS ESPECÍFICOS ===

;; Electric pair - leve
(electric-pair-mode 1)

;; C mode
(setq-default c-basic-offset 4
              c-default-style '((java-mode . "java")
                                (go-ts-mode . "go")
                                (awk-mode . "awk")
                                (other . "bsd")))

(add-hook 'c-mode-hook
          (lambda ()
            (c-toggle-comment-style -1)))

;; Emacs Lisp
(add-hook 'emacs-lisp-mode-hook
          (lambda ()
            (local-set-key (kbd "C-c C-j") 'eval-print-last-sexp)))

;; Word wrap para markdown
(defun rc/enable-word-wrap ()
  (toggle-word-wrap 1))
(add-hook 'markdown-mode-hook 'rc/enable-word-wrap)

;; Modos de arquivo
(add-to-list 'auto-mode-alist '("Cask" . emacs-lisp-mode))
(add-to-list 'auto-mode-alist '("\\.html\\'" . nxml-mode))
(add-to-list 'auto-mode-alist '("\\.xsd\\'" . nxml-mode))
(add-to-list 'auto-mode-alist '("\\.ant\\'" . nxml-mode))
(add-to-list 'auto-mode-alist '("\\.ebi\\'" . lisp-mode))

;;; === CONFIRMAÇÕES AUTOMÁTICAS ===
;; Desativar confirmações para operações de arquivo
(setq confirm-nonexistent-file-or-buffer nil)
(setq confirm-kill-processes nil)

;; Para renomear arquivos (dired)
(eval-after-load 'dired
  '(progn
     (defun dired-rename-file-yes () 
       "Renomear arquivo sem confirmação"
       (interactive)
       (let ((file (dired-get-filename)))
         (dired-rename-file file (read-string "Novo nome: ") nil)))
     
     (define-key dired-mode-map (kbd "R") 'dired-rename-file-yes)))

;; Para apagar arquivos (dired)
(eval-after-load 'dired
  '(progn
     (defun dired-delete-file-yes ()
       "Apagar arquivo sem confirmação"
       (interactive)
       (let ((file (dired-get-filename)))
         (delete-file file)
         (revert-buffer)))
     
     (define-key dired-mode-map (kbd "D") 'dired-delete-file-yes)))

;; Configuração global para confirmações
(setq confirm-kill-emacs nil)  ; Sair sem confirmar

;; TRAMP
(setq tramp-auto-save-directory "/tmp")

;;; === CONFIGURAÇÕES FINAIS DE PERFORMANCE ===

;; Reset final do GC após tudo carregado
(add-hook 'emacs-startup-hook
  (lambda ()
    (setq gc-cons-threshold 800000)  ; Voltar ao padrão
    (message "Emacs carregado em %.2f segundos (Otimizado!)" 
             (float-time (time-subtract after-init-time before-init-time)))))

;; Arquivo custom
(setq custom-file "~/.emacs.custom.el")
(load custom-file 'noerror)

;; Load path local
(add-to-list 'load-path "~/.emacs.local/")

(message "✅ Configuração otimizada carregada!")
