;;; === CONFIGURA√á√ïES CR√çTICAS DE PERFORMANCE ===
;; Otimiza√ß√µes RADICAIS que devem vir ANTES de tudo
(setq gc-cons-threshold 200000000)  ; 200MB durante carregamento
(setq read-process-output-max (* 8 1024 1024))  ; 8MB para I/O
(setq inhibit-startup-screen t)
(setq inhibit-startup-message t)
(setq inhibit-startup-echo-area-message t)
(setq initial-major-mode 'fundamental-mode)
(setq initial-scratch-message nil)
(setq message-log-max 1000)  ; Limitar logs

;; Performance de UI radical
(setq idle-update-delay 1.0)
(setq redisplay-skip-fontification-on-input t)
(setq auto-window-vscroll nil)
(setq fast-but-imprecise-scrolling t)
(setq jit-lock-stealth-time 5)
(setq jit-lock-defer-time 0.5)

;; Interface m√≠nima ULTRA radical
(tool-bar-mode -1)
(menu-bar-mode -1) 
(scroll-bar-mode -1)
(setq visible-bell nil)
(setq ring-bell-function 'ignore)
(setq use-dialog-box nil)
(setq use-file-dialog nil)

;;; === SISTEMA DE PACOTES (Turbo) ===
(require 'package)
(let ((timeout 10))
  (add-to-list 'package-archives '("melpa" . "https://melpa.org/packages/") t)
  (package-initialize)

  ;; Bootstrap use-package ULTRA r√°pido
  (unless (package-installed-p 'use-package)
    (with-timeout (timeout (message "Timeout package refresh"))
      (package-refresh-contents)))
  
  (unless (package-installed-p 'use-package)
    (package-install 'use-package)))

(require 'use-package)
(setq use-package-always-ensure t)
(setq use-package-expand-minimally t)  ; üëà CR√çTICO para performance
(setq use-package-enable-imenu-support nil)

;;; === CONFIGURA√á√ïES PESSOAIS (M√≠nimas) ===
(defun display-warning (&rest _args) nil)
(setq warning-minimum-level :emergency)
(global-set-key [C-tab] 'other-window)

;; Configura√ß√µes de tab
(setq tab-width 4)
(setq-default indent-tabs-mode nil)

;; Transpar√™ncia
(add-to-list 'default-frame-alist '(alpha . (92 . 87)))

;;; === PACOTES COM CARREGAMENTO ULTRA TARDIO ===

;; Evil mode - apenas o essencial
(use-package evil
  :ensure t
  :demand t
  :config
  (evil-mode 1)
  ;; M√çNIMO de configura√ß√µes
  (setq evil-want-fine-undo t)
  (setq evil-search-module 'evil-search))

;; Vertico - config m√≠nimo
(use-package vertico
  :ensure t
  :init (vertico-mode)
  :config
  (setq vertico-cycle t)
  (setq vertico-count 8))  ; Ainda menos resultados

;; Consult - carregamento MUITO tardio
(use-package consult
  :ensure t
  :defer 3  ; 3 segundos ap√≥s inatividade
  :bind (("C-s" . consult-line)
         ("C-c h" . consult-history)
         ("C-x 8" . consult-imenu)
         ("C-c f" . consult-find)
         ("C-c r" . consult-ripgrep)))

;; Orderless - m√≠nimo
(use-package orderless
  :ensure t
  :defer 2
  :custom (completion-styles '(orderless basic)))  ; basic como fallback

;; Marginalia - MUITO tardio
(use-package marginalia
  :ensure t
  :after vertico
  :defer 5  ; 5 segundos!
  :init (marginalia-mode))

;; Tema - usar tema EMBUTIDO (remove gruber-darker)
;; REMOVER completamente: (use-package gruber-darker-theme ...)

;;; === MODOS DE LINGUAGEM (Sob demanda REAL) ===

;; TypeScript - apenas quando ABRIR arquivo
(use-package typescript-mode
  :ensure t
  :defer t
  :mode ("\\.tsx?\\'" . typescript-mode)
  :init (setq typescript-indent-level 2))

;; Go - apenas quando ABRIR arquivo  
(use-package go-ts-mode
  :ensure t
  :defer t
  :mode ("\\.go\\'" . go-ts-mode))

;; Elixir - apenas quando ABRIR arquivo
(use-package elixir-mode
  :ensure t
  :defer t
  :hook (elixir-mode . (lambda () (subword-mode 1)))
  :config (setq elixir-basic-offset 2))

;;; === CONFIGURA√á√ïES DE APAR√äNCIA (ADIADAS) ===

;; Fontes - ADIAR significativamente
(run-with-idle-timer 3 nil
  (lambda ()
    (add-to-list 'default-frame-alist '(font . "Iosevka-14"))))  ; Tamanho menor = mais r√°pido

;; Line numbers - APENAS quando necess√°rio
(run-with-idle-timer 2 nil
  (lambda ()
    (add-hook 'prog-mode-hook 'display-line-numbers-mode)))

;; Maximizar - ADIAR
(run-with-idle-timer 1 nil 'toggle-frame-maximized)

;; Tema EMBUTIDO - carregar r√°pido
(load-theme 'tango-dark t)

;;; === CONFIGURA√á√ïES DE PERFORMANCE RADICAIS ===

;; GC inteligente AGGRESSIVO
(defun my-minibuffer-setup-hook ()
  (setq gc-cons-threshold 400000000))  ; 400MB durante minibuffer!

(defun my-minibuffer-exit-hook ()
  (setq gc-cons-threshold 200000000))  ; 200MB ap√≥s minibuffer

(add-hook 'minibuffer-setup-hook #'my-minibuffer-setup-hook)
(add-hook 'minibuffer-exit-hook #'my-minibuffer-exit-hook)

;; Sistema de arquivos ULTRA r√°pido
(setq auto-save-default nil)  ; üö® DESATIVAR auto-save durante startup
(setq create-lockfiles nil)
(setq backup-directory-alist `(("." . "~/.emacs.d/backups")))
(setq auto-save-list-file-prefix nil)  ; N√£o criar auto-save-list

;; Busca r√°pida
(setq case-fold-search t)
(setq search-upper-case 'not-symbols)

;;; === CONFIGURA√á√ïES ADICIONAIS (ADIADAS RADICALMENTE) ===

;; Midnight - ADIAR muito
(run-with-idle-timer 15 nil 
  (lambda ()
    (require 'midnight)
    (midnight-mode 1)))

;; Tree-sitter - apenas se necess√°rio
(run-with-idle-timer 10 nil
  (lambda ()
    (when (fboundp 'treesit-available-p)
      (setq treesit-font-lock-level 1))))  ; N√≠vel M√çNIMO

;; Eglot - CARREGAMENTO POR DEMANDA REAL
(use-package eglot
  :ensure t
  :defer t
  :commands (eglot eglot-ensure)
  :init
  (setq eglot-events-buffer-size 0
        eglot-sync-connect 0
        eglot-connect-timeout 30))

;;; === CONFIGURA√á√ïES DE MODOS (M√çNIMAS) ===

;; Electric pair - leve
(electric-pair-mode 1)

;; C mode - configura√ß√£o m√≠nima
(setq-default c-basic-offset 4)
(add-hook 'c-mode-hook (lambda () (c-toggle-comment-style -1)))

;; Emacs Lisp - apenas o essencial
(add-hook 'emacs-lisp-mode-hook
          (lambda ()
            (local-set-key (kbd "C-c C-j") 'eval-print-last-sexp)))

;; Word wrap - apenas quando necess√°rio
(add-hook 'markdown-mode-hook (lambda () (toggle-word-wrap 1)))

;; Modos de arquivo - direto
(dolist (pair '(("Cask" . emacs-lisp-mode)
                ("\\.html\\'" . nxml-mode)
                ("\\.xsd\\'" . nxml-mode)
                ("\\.ant\\'" . nxml-mode)
                ("\\.ebi\\'" . lisp-mode)))
  (add-to-list 'auto-mode-alist pair))

;;; === CONFIRMA√á√ïES AUTOM√ÅTICAS ===
(setq confirm-nonexistent-file-or-buffer nil)
(setq confirm-kill-processes nil)
(setq confirm-kill-emacs nil)

;; TRAMP config m√≠nima
(setq tramp-auto-save-directory "/tmp")

;;; === CONFIGURA√á√ïES FINAIS DE PERFORMANCE ===

;; Reset FINAL do GC
(add-hook 'emacs-startup-hook
  (lambda ()
    (setq gc-cons-threshold 800000)  ; Voltar ao normal
    ;; Re-ativar auto-save AP√ìS startup
    (setq auto-save-default t)
    (message "Emacs TURBO carregado em %.2f segundos!" 
             (float-time (time-subtract after-init-time before-init-time)))))

;;; === CONFIGURA√á√ÉO DO ARQUIVO CUSTOM ===
;; TUDO que for configurado via customize vai para este arquivo
(setq custom-file "~/.emacs.d/custom.el")

;; Carregar o arquivo custom se existir
(when (file-exists-p custom-file)
  (load custom-file))

;; Fun√ß√£o para garantir que customiza√ß√µes sejam salvas no lugar certo
(defun my-save-custom-file ()
  "Salvar customiza√ß√µes no arquivo correto."
  (unless (file-exists-p custom-file)
    (write-region "" nil custom-file))
  (custom-save-all))

;; Salvar automaticamente quando usar customize
(setq custom-save-dir "~/.emacs.d/")
(add-hook 'after-init-hook 'my-save-custom-file)

;; Mensagem final MINIMAL
(message "Iniciando...")
