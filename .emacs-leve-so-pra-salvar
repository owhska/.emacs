;;; === NUCLEAR PERFORMANCE CONFIGURATIONS ===
;; ABSOLUTE MINIMUM - optimized for i3wm
(setq gc-cons-threshold 10000000)      ; 10MB
(setq read-process-output-max (* 1 1024 1024))  ; 1MB I/O
(setq inhibit-startup-screen t)
(setq inhibit-startup-message t)
(setq inhibit-startup-echo-area-message t)
(setq initial-major-mode 'fundamental-mode)
(setq initial-scratch-message nil)
(setq message-log-max 0)
(setq auto-save-default nil)
(setq create-lockfiles nil)
(setq make-backup-files nil)

;; Kill ALL UI delays
(setq idle-update-delay 0.1)
(setq redisplay-skip-fontification-on-input t)
(setq auto-window-vscroll nil)
(setq fast-but-imprecise-scrolling t)

;; Murder unnecessary features
(setq-default cursor-in-non-selected-windows nil)
(setq highlight-nonselected-windows nil)
(setq echo-keystrokes 0)
(setq large-file-warning-threshold nil)
(setq font-lock-maximum-size 100000)

;; i3wm-specific optimizations
(setq frame-resize-pixelwise t)        ; Better for tiling WMs
(setq frame-inhibit-implied-resize t)  ; Prevent auto-resize
(setq fit-window-to-buffer-horizontally 'never) ; No horizontal resize
(setq even-window-heights nil)         ; Don't enforce equal heights

;;; === i3WM INTERFACE FIXES ===
;; Apply BEFORE package init
(tool-bar-mode -1)
(menu-bar-mode -1)
(scroll-bar-mode -1)
(tooltip-mode -1)
(setq use-dialog-box nil)
(setq use-file-dialog nil)
(setq inhibit-compacting-font-caches t)

;; i3wm frame settings
(add-to-list 'default-frame-alist '(undecorated . t)) ; No window decorations
(add-to-list 'default-frame-alist '(no-special-glyphs . t))
(add-to-list 'default-frame-alist '(drag-internal-border . 1))
(add-to-list 'default-frame-alist '(internal-border-width . 1))

;; Fix for i3wm focus issues
(setq mouse-autoselect-window nil)
(setq focus-follows-mouse nil)
(setq x-mouse-click-focus-ignore-position t)

;;; === INSTANT EVIL - OPTIMIZED FOR i3 ===
;; Try to load evil directly first
(condition-case nil
    (progn
      (load "evil-autoloads" nil t)
      (require 'evil)
      (evil-mode 1))
  (error
   (progn
     ;; Fallback with package system
     (require 'package)
     (setq package-archives '(("melpa" . "https://melpa.org/packages/")
                              ("gnu" . "https://elpa.gnu.org/packages/")))
     (setq package-enable-at-startup nil)
     (package-initialize)
     
     (unless (package-installed-p 'evil)
       (package-install 'evil))
     
     (require 'evil)
     ;; i3wm-friendly Evil settings
     (setq evil-want-integration nil)
     (setq evil-want-C-u-scroll t)
     (setq evil-want-C-i-jump nil)
     (setq evil-respect-visual-line-mode t) ; Better for tiling
     (evil-mode 1))))

;; Essential Evil keybindings for i3wm
(when (featurep 'evil)
  (define-key evil-normal-state-map (kbd "C-s") 'save-buffer)
  (define-key evil-normal-state-map (kbd "C-w") 'evil-window-map)
  ;; i3-like window navigation
  (define-key evil-normal-state-map (kbd "M-h") 'evil-window-left)
  (define-key evil-normal-state-map (kbd "M-j") 'evil-window-down)
  (define-key evil-normal-state-map (kbd "M-k") 'evil-window-up)
  (define-key evil-normal-state-map (kbd "M-l") 'evil-window-right))

;;; === HYPER-OPTIMIZED GC ===
(setq gc-cons-threshold 5000000)   ; 5MB normal
(defun my-micro-gc-optimize ()
  (setq gc-cons-threshold 10000000))  ; 10MB during insert
(defun my-micro-gc-restore ()
  (setq gc-cons-threshold 5000000))

(add-hook 'evil-insert-state-entry-hook 'my-micro-gc-optimize)
(add-hook 'evil-insert-state-exit-hook 'my-micro-gc-restore)

;;; === ESSENTIAL EDITING ===
(show-paren-mode 1)
(setq show-paren-delay 0)
(delete-selection-mode 1)
(setq tab-width 4)
(setq-default indent-tabs-mode nil)

;;; === INSTANT SEARCH ===
(setq case-fold-search t)
(global-set-key (kbd "C-s") 'isearch-forward)
(global-set-key (kbd "C-r") 'isearch-backward)

;; Fast file find for i3wm
(defun i3-fast-find ()
  "Fast file find optimized for i3wm."
  (interactive)
  (let ((default-directory "~/"))  ; Start at home
    (call-interactively 'find-file)))
(global-set-key (kbd "C-x C-f") 'i3-fast-find)

;;; === MINIMAL MODE-LINE FOR i3 ===
;; Keep mode-line but minimal
(setq-default mode-line-format
  '(" %b "
    (:eval (if (buffer-modified-p) "â—" ""))
    " %l "))

;;; === i3WM-FRIENDLY DISPLAY ===
;; Font settings for i3wm
(add-to-list 'default-frame-alist '(font . "Monospace-10"))
(set-face-attribute 'default nil :family "Monospace" :height 100)

;; Colors optimized for i3wm (high contrast)
(set-face-background 'default "#000000")
(set-face-foreground 'default "#ffffff")
(set-face-background 'region "#444444")
(set-face-foreground 'region "#ffffff")
(set-cursor-color "#00ffff")

;; Line numbers - optional for i3wm
(defun i3-toggle-line-numbers ()
  "Toggle line numbers for i3wm."
  (interactive)
  (display-line-numbers-mode (if display-line-numbers-mode -1 1)))
(global-set-key (kbd "C-c n") 'i3-toggle-line-numbers)

;;; === i3WM WINDOW MANAGEMENT ===
;; Better window splitting for tiling WM
(setq split-width-threshold 160)  ; Split vertically if > 160 cols
(setq split-height-threshold nil) ; Always split horizontally

;; i3-like window commands
(global-set-key (kbd "M-1") 'delete-other-windows)
(global-set-key (kbd "M-2") 'split-window-below)
(global-set-key (kbd "M-3") 'split-window-right)
(global-set-key (kbd "M-0") 'delete-window)

;;; === LAZY PACKAGE LOADING ===
;; LSP - load only when needed
(defun i3-lazy-lsp ()
  "Load LSP on demand for i3wm."
  (when (and (buffer-file-name)
             (string-match "\\.\\(py\\|js\\|ts\\|java\\|go\\|rs\\|c\\|cpp\\)$" 
                          (buffer-file-name)))
    (run-with-idle-timer 2 nil
      (lambda ()
        (require 'package)
        (package-initialize)
        (unless (package-installed-p 'lsp-mode)
          (package-install 'lsp-mode))
        (require 'lsp-mode)
        (setq lsp-enable-symbol-highlighting nil
              lsp-ui-sideline-enable nil
              lsp-ui-doc-enable nil
              lsp-headerline-breadcrumb-enable nil)
        (lsp-deferred)))))
(add-hook 'find-file-hook 'i3-lazy-lsp)

;; Company - minimal setup
(defun i3-lazy-company ()
  "Load company for i3wm."
  (run-with-idle-timer 3 nil
    (lambda ()
      (require 'package)
      (package-initialize)
      (unless (package-installed-p 'company)
        (package-install 'company))
      (require 'company)
      (setq company-idle-delay 0.3
            company-minimum-prefix-length 1
            company-tooltip-limit 5)
      (global-company-mode 1))))

;;; === i3WM PERFORMANCE TWEAKS ===
;; Fix rendering for i3wm
(setq-default left-margin-width 0)
(setq-default right-margin-width 0)
(setq-default left-fringe-width 0)
(setq-default right-fringe-width 0)

;; Scroll behavior for i3wm
(setq scroll-margin 0)
(setq scroll-conservatively 10000)
(setq scroll-preserve-screen-position t)

;; Disable smooth scrolling (causes issues in i3)
(setq scroll-step 1)
(setq mouse-wheel-scroll-amount '(1 ((shift) . 1)))
(setq mouse-wheel-progressive-speed nil)

;;; === FIX i3WM FOCUS ISSUES ===
;; Prevent focus stealing
(setq x-focus-frame nil)
(remove-hook 'post-command-hook 'x-focus-frame)
(setq minibuffer-auto-raise nil)

;; Better focus handling for i3wm
(defun i3-focus-workaround ()
  "Workaround for i3wm focus issues."
  (when (display-graphic-p)
    (raise-frame)
    (select-frame-set-input-focus (selected-frame))))
(add-hook 'window-configuration-change-hook 'i3-focus-workaround)

;;; === AUTO-MODE FOR i3wm ===
;; Minimal auto-mode for performance
(add-to-list 'auto-mode-alist '("\\.py\\'" . python-mode))
(add-to-list 'auto-mode-alist '("\\.js\\'" . js-mode))
(add-to-list 'auto-mode-alist '("\\.ts\\'" . typescript-mode))
(add-to-list 'auto-mode-alist '("\\.java\\'" . java-mode))
(add-to-list 'auto-mode-alist '("\\.go\\'" . go-mode))
(add-to-list 'auto-mode-alist '("\\.rs\\'" . rust-mode))
(add-to-list 'auto-mode-alist '("\\.c\\'" . c-mode))
(add-to-list 'auto-mode-alist '("\\.cpp\\'" . c++-mode))

;;; === DISABLE WARNINGS ===
(setq warning-minimum-level :emergency)
(defun silence-all (&rest _) nil)
(advice-add 'display-warning :override 'silence-all)

;;; === i3WM STARTUP OPTIMIZATION ===
;; Don't maximize - let i3 handle window placement
(add-to-list 'initial-frame-alist '(fullscreen . nil))
(add-to-list 'initial-frame-alist '(width . 80))
(add-to-list 'initial-frame-alist '(height . 40))

;; Startup timing
(add-hook 'emacs-startup-hook
  (lambda ()
    (let ((startup-time (float-time 
                         (time-subtract after-init-time before-init-time))))
      (if (< startup-time 0.3)
          (message "ðŸš€ i3wm Emacs: %.3fs" startup-time)
        (message "Startup: %.3fs" startup-time)))
    ;; Force GC to clean startup
    (garbage-collect)))

;; Start i3 lazy loading
(run-with-idle-timer 1 nil 'i3-lazy-company)

;; Final message
(message "i3wm Emacs loading...")
(custom-set-variables
 ;; custom-set-variables was added by Custom.
 ;; If you edit it by hand, you could mess it up, so be careful.
 ;; Your init file should contain only one such instance.
 ;; If there is more than one, they won't work right.
 '(package-selected-packages '(company evil)))
(custom-set-faces
 ;; custom-set-faces was added by Custom.
 ;; If you edit it by hand, you could mess it up, so be careful.
 ;; Your init file should contain only one such instance.
 ;; If there is more than one, they won't work right.
 )
